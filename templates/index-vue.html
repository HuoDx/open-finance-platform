<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/css/mdui.min.css" />
    <style>
    .statistics-layout {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }
    .stats-card {
      margin-left: 8px;
      margin-right: 8px;
      padding: 8px;
      width: 100px;
      height: 100px;
      text-align: center;
      align-items: center;
    }
    .head-container {
      margin: 0;
      margin-bottom: 24px;
      padding-bottom: 16px;
    }
    .bottom-page-navigator {
      display: flex;
      flex-direction: row;
      justify-content: center;
    }
    a {
      margin-left: 4px;
      margin-right: 4px;
    }
    </style>
</head>

<body>
    <div class="mdui-shadow-2 head-container">
      <div class="mdui-toolbar ">
          <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
          <span class="mdui-typo-title">Open Finance Data</span>
          <div class="mdui-toolbar-spacer"></div>
          <a href="/" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">refresh</i></a>
      </div>
      <div class="statistics-layout">

          <div class="mdui-card stats-card">
            <p>Total Revenue</p>
            <p>1000</p>
          </div>

          <div class="mdui-card stats-card">
            <p>Total Cost</p>
            <p>1000</p>
          </div>

      </div>
    </div>
    <div class="mdui-panel" mdui-panel>
      {% for finance_object in data_object['finance_objects'] %}
        <div class="mdui-panel-item">
            <div class="mdui-panel-item-header">
                <div class="mdui-panel-item-title">{{finance_object['amount'] / 100.0}} CNY</div>
                <div class="mdui-panel-item-summary">Date: {{finance_object['timestamp'] }}</div>
                <i class="mdui-panel-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
            </div>
            <div class="mdui-panel-item-body">

                {% if finance_object['description'] == '' %}
                <p>An auto-generated revenue event</p>
                {% else %}
                <p>{{finance_object['description']}}</p>
                {% endif %}

                <div class="mdui-panel-item-actions">
                    <button class="mdui-btn mdui-ripple" mdui-panel-item-close>close</button>
                    <a class="mdui-btn mdui-btn-raised mdui-ripple" href="/">Download evidence</a>
                </div>
            </div>
        </div>
      {% endfor %}
      <input type="date" id="d"></input>
      <p class="bottom-page-navigator">
      <a href='/'>1</a>
      <a href='/'>2</a>
      <a href='/'>3</a>
      <a href='/'>4</a>
      </p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js" integrity="sha512-szJ5FSo9hEmXXe7b5AUVtn/WnL8a5VofnFeYC2i2z03uS2LhAch7ewNLbl5flsEmTTimMN0enBZg/3sQ+YOSzQ==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/js/mdui.min.js"></script>
    <script>
    (async () => {


      var examineBuilder = function (numberOfDigits = 5) {
        var examiner = function(value) {
          for(let ch of value.substring(0, numberOfDigits)) {
            if(ch != '0') return false
          }
          return true
        }
        return examiner
      }

      var mine = function (examiner, hasher, message) {
        let nonce = Math.random().toString(16).replace('.','').substring(0,10)
        let steps = 10000
        while (!examiner(hasher(message+nonce))) {
          nonce = Math.random().toString(16).replace('.','').substring(0,10)
        }
        return nonce;
      }
      var jsonFetch = async function(url) {
        let response = await fetch(url)
        let jsonResponse = await response.json()
        return jsonResponse
      }

      statsJson = await jsonFetch(`/api/stats`)
      console.log(statsJson)

      jsonResponse = await jsonFetch('/api/take-challenge')
      
      console.log(jsonResponse)
      var nonce = await mine(examineBuilder(5), sha256, jsonResponse.result)
      console.log(nonce)
      console.log(sha256(jsonResponse.result + nonce))
      
      allDataJson = await jsonFetch(`/api/poll/${jsonResponse.result}/${nonce}`)
      console.log(allDataJson.result)

      
    })();
    </script>
</body>

</html>